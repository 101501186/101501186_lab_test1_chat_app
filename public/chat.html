<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Welcome, <span id="username"></span></h1>
  <h2>Room: <span id="roomName"></span></h2>
  <button onclick="leaveRoom()">Leave Room</button>

  <div id="chat" style="border:1px solid #000; height:300px; overflow-y:scroll; margin-top:10px; padding:5px"></div>

  <p id="typing"></p>
  
  <input id="msg" placeholder="Type a message">
  <button onclick="sendMsg()">Send</button>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Get logged-in user and selected room from localStorage
    const username = localStorage.getItem("user");
    const currentRoom = localStorage.getItem("room");

    if (!username || !currentRoom) {
      alert("You must login and select a room first");
      window.location.href = "login.html";
    }

    document.getElementById("username").innerText = username;
    document.getElementById("roomName").innerText = currentRoom;

    const socket = io();

    // Join the selected room
    socket.emit("joinRoom", currentRoom);

    // Send message
    const msgInput = document.getElementById("msg");
    const chatDiv = document.getElementById("chat");
    const typingP = document.getElementById("typing");

    function sendMsg() {
      if (!msgInput.value) return;
      socket.emit("chatMessage", {
        from_user: username,
        room: currentRoom,
        message: msgInput.value
      });
      msgInput.value = "";
    }

    // Typing indicator
    msgInput.oninput = () => {
      socket.emit("typing", { room: currentRoom, username });
    };

    // Listen for messages
    socket.on("message", (data) => {
      chatDiv.innerHTML += `<p><strong>${data.from_user}:</strong> ${data.message}</p>`;
      chatDiv.scrollTop = chatDiv.scrollHeight; // scroll to bottom
      typingP.innerText = "";
    });

    // Listen for typing
    socket.on("typing", (user) => {
      typingP.innerText = user + " is typing...";
    });

    // Leave room
    function leaveRoom() {
      localStorage.removeItem("room");
      window.location.href = "rooms.html";
    }
  </script>
</body>
</html>
